<!DOCTYPE html>
<html>

<head>
    <title>Farmer QR Code Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .qr-preview {
            display: inline-block;
            margin: 15px;
            padding: 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .qr-preview canvas {
            margin-bottom: 10px;
        }

        .farmer-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .farmer-info {
            font-size: 12px;
            color: #666;
        }

        .btn {
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .controls {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
            padding: 20px;
            background: #fafafa;
            border-radius: 10px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        select,
        input[type="number"] {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            margin: 5px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üì± Farmer QR Code Generator</h1>
        <p class="subtitle">Generate QR codes for farmers to enable quick access to their profiles</p>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalFarmers">0</div>
                <div class="stat-label">Total Farmers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="selectedCount">0</div>
                <div class="stat-label">Selected</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="qrCount">0</div>
                <div class="stat-label">QR Codes Generated</div>
            </div>
        </div>

        <div class="controls">
            <h3>üéØ Select QR Type</h3>

            <label style="display: block; padding: 10px; background: #f0f0f0; margin: 5px 0; border-radius: 5px;">
                <input type="radio" name="qrType" value="farmers" checked onchange="updateQRType()">
                <strong>Farmer Profiles</strong> - Generate QR codes for farmer profiles
            </label>

            <label style="display: block; padding: 10px; background: #f0f0f0; margin: 5px 0; border-radius: 5px;">
                <input type="radio" name="qrType" value="equipment" onchange="updateQRType()">
                <strong>Scanned Equipment</strong> - Recreate QR codes for all scanned items (Controllers, Pumps,
                Panels, Motors)
            </label>

            <div id="farmerOptions" style="margin-top: 15px;">
                <h4>üë• Farmer Selection</h4>
                <label>
                    <input type="radio" name="selection" value="all" checked onchange="updateSelection()">
                    Generate for ALL farmers
                </label>
                <br>
                <label>
                    <input type="radio" name="selection" value="range" onchange="updateSelection()">
                    Generate for range:
                    <input type="number" id="rangeStart" min="1" value="1" style="width: 80px;">
                    to
                    <input type="number" id="rangeEnd" min="1" value="10" style="width: 80px;">
                </label>
                <br>
                <label>
                    <input type="radio" name="selection" value="status" onchange="updateSelection()">
                    Filter by status:
                    <select id="statusFilter">
                        <option value="pending">Pending Unloading</option>
                        <option value="done">Unloading Done</option>
                        <option value="all">All Status</option>
                    </select>
                </label>
            </div>

            <div id="equipmentOptions" style="margin-top: 15px; display: none;">
                <h4>‚öôÔ∏è Equipment Selection</h4>
                <label>
                    <input type="checkbox" id="includeControllers" checked> Controllers
                </label>
                <label>
                    <input type="checkbox" id="includePumps" checked> Pumps
                </label>
                <label>
                    <input type="checkbox" id="includePanels" checked> Panel Serials
                </label>
                <label>
                    <input type="checkbox" id="includeMotors" checked> Motors
                </label>
            </div>

            <br>

            <label>
                QR Code Size:
                <select id="qrSize">
                    <option value="128">Small (128x128)</option>
                    <option value="200" selected>Medium (200x200)</option>
                    <option value="256">Large (256x256)</option>
                </select>
            </label>

            <label>
                QR Codes per page:
                <select id="qrPerPage">
                    <option value="4">4 (2x2)</option>
                    <option value="6" selected>6 (2x3)</option>
                    <option value="9">9 (3x3)</option>
                    <option value="12">12 (3x4)</option>
                </select>
            </label>

            <br><br>

            <button class="btn btn-primary" onclick="generateQRCodes()">
                üì± Generate QR Codes
            </button>

            <button class="btn btn-success" onclick="downloadPDF()" id="downloadBtn" disabled>
                üìÑ Download PDF
            </button>
        </div>

        <div class="preview-container" id="previewContainer">
            <p style="color: #999;">Click "Generate QR Codes" to preview</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAfRYoZT9c4O0flc39iROdgC1bTQkUXq88",
            authDomain: "gen-lang-client-0579320558.firebaseapp.com",
            projectId: "gen-lang-client-0579320558",
            storageBucket: "gen-lang-client-0579320558.firebasestorage.app",
            messagingSenderId: "770401014858",
            appId: "1:770401014858:web:placeholder"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allFarmers = [];
        let generatedQRs = [];

        // Load farmers on page load
        async function loadFarmers() {
            try {
                const q = query(collection(db, 'farmers_master'), orderBy('name'));
                const snapshot = await getDocs(q);

                allFarmers = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                document.getElementById('totalFarmers').textContent = allFarmers.length;
                updateSelection();
            } catch (error) {
                console.error('Error loading farmers:', error);
                alert('Error loading farmers: ' + error.message);
            }
        }

        window.updateSelection = () => {
            const selection = document.querySelector('input[name="selection"]:checked').value;
            let count = 0;

            if (selection === 'all') {
                count = allFarmers.length;
            } else if (selection === 'range') {
                const start = parseInt(document.getElementById('rangeStart').value);
                const end = parseInt(document.getElementById('rangeEnd').value);
                count = Math.min(end, allFarmers.length) - start + 1;
            } else if (selection === 'status') {
                const status = document.getElementById('statusFilter').value;
                if (status === 'all') {
                    count = allFarmers.length;
                } else {
                    count = allFarmers.filter(f => f.unloading_status === status).length;
                }
            }

            document.getElementById('selectedCount').textContent = Math.max(0, count);
        };

        window.updateQRType = () => {
            const qrType = document.querySelector('input[name="qrType"]:checked').value;
            const farmerOptions = document.getElementById('farmerOptions');
            const equipmentOptions = document.getElementById('equipmentOptions');

            if (qrType === 'farmers') {
                farmerOptions.style.display = 'block';
                equipmentOptions.style.display = 'none';
                updateSelection();
            } else {
                farmerOptions.style.display = 'none';
                equipmentOptions.style.display = 'block';
                loadEquipmentCount();
            }
        };

        async function loadEquipmentCount() {
            try {
                const snapshot = await getDocs(collection(db, 'unloading_records'));
                let count = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (document.getElementById('includeControllers').checked && data.controller_qr) count++;
                    if (document.getElementById('includePumps').checked && data.pump_qr) count++;
                    if (document.getElementById('includeMotors').checked && data.motor_serial) count++;
                    if (document.getElementById('includePanels').checked && data.panel_serials) {
                        count += data.panel_serials.filter(p => p).length;
                    }
                });

                document.getElementById('selectedCount').textContent = count;
            } catch (error) {
                console.error('Error loading equipment count:', error);
            }
        }

        async function generateEquipmentQRs() {
            const previewContainer = document.getElementById('previewContainer');
            const qrSize = parseInt(document.getElementById('qrSize').value);

            generatedQRs = [];
            previewContainer.innerHTML = '';

            try {
                const snapshot = await getDocs(collection(db, 'unloading_records'));

                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    const farmerName = data.farmer_name || 'Unknown';

                    // Generate Controller QR
                    if (document.getElementById('includeControllers').checked && data.controller_qr) {
                        await createEquipmentQR(data.controller_qr, 'Controller', farmerName, qrSize, previewContainer);
                    }

                    // Generate Pump QR
                    if (document.getElementById('includePumps').checked && data.pump_qr) {
                        await createEquipmentQR(data.pump_qr, 'Pump', farmerName, qrSize, previewContainer);
                    }

                    // Generate Motor QR
                    if (document.getElementById('includeMotors').checked && data.motor_serial) {
                        await createEquipmentQR(data.motor_serial, 'Motor', farmerName, qrSize, previewContainer);
                    }

                    // Generate Panel QRs
                    if (document.getElementById('includePanels').checked && data.panel_serials) {
                        for (let i = 0; i < data.panel_serials.length; i++) {
                            const panelSerial = data.panel_serials[i];
                            if (panelSerial) {
                                await createEquipmentQR(panelSerial, `Panel #${i + 1}`, farmerName, qrSize, previewContainer);
                            }
                        }
                    }
                }

                document.getElementById('qrCount').textContent = generatedQRs.length;
                document.getElementById('downloadBtn').disabled = false;
                previewContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            } catch (error) {
                console.error('Error generating equipment QRs:', error);
                previewContainer.innerHTML = `<p style="color: #f00;">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function createEquipmentQR(serial, equipmentType, farmerName, qrSize, container) {
            const qrData = JSON.stringify({
                serial: serial,
                type: equipmentType.toLowerCase(),
                farmer: farmerName,
                qr_type: 'equipment'
            });

            const qrDiv = document.createElement('div');
            qrDiv.className = 'qr-preview';

            const qrContainer = document.createElement('div');
            qrDiv.appendChild(qrContainer);

            new QRCode(qrContainer, {
                text: serial, // Just the serial number for scanning
                width: qrSize,
                height: qrSize,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            const label = document.createElement('div');
            label.className = 'farmer-label';
            label.textContent = serial;
            qrDiv.appendChild(label);

            const info = document.createElement('div');
            info.className = 'farmer-info';
            info.innerHTML = `${equipmentType}<br>${farmerName}`;
            qrDiv.appendChild(info);

            container.appendChild(qrDiv);

            generatedQRs.push({
                farmer: { name: `${equipmentType} - ${farmerName}`, location: serial, phone: equipmentType },
                qrElement: qrDiv
            });

            await new Promise(resolve => setTimeout(resolve, 30));
        }

        window.generateQRCodes = async () => {
            const qrType = document.querySelector('input[name="qrType"]:checked').value;

            if (qrType === 'equipment') {
                await generateEquipmentQRs();
                return;
            }

            // Original farmer QR code generation
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = '<p style="color: #667eea; font-size: 18px;">‚è≥ Generating QR codes...</p>';

            generatedQRs = [];

            // Get selected farmers
            let selectedFarmers = [];
            const selection = document.querySelector('input[name="selection"]:checked').value;

            if (selection === 'all') {
                selectedFarmers = allFarmers;
            } else if (selection === 'range') {
                const start = parseInt(document.getElementById('rangeStart').value) - 1;
                const end = parseInt(document.getElementById('rangeEnd').value);
                selectedFarmers = allFarmers.slice(start, end);
            } else if (selection === 'status') {
                const status = document.getElementById('statusFilter').value;
                if (status === 'all') {
                    selectedFarmers = allFarmers;
                } else {
                    selectedFarmers = allFarmers.filter(f => f.unloading_status === status);
                }
            }

            if (selectedFarmers.length === 0) {
                previewContainer.innerHTML = '<p style="color: #f00;">‚ùå No farmers found matching your selection</p>';
                return;
            }

            previewContainer.innerHTML = '';
            const qrSize = parseInt(document.getElementById('qrSize').value);

            // Generate QR codes
            for (const farmer of selectedFarmers) {
                const qrData = JSON.stringify({
                    id: farmer.id,
                    name: farmer.name,
                    phone: farmer.phone,
                    location: farmer.location,
                    hp: farmer.hp,
                    type: 'farmer_profile'
                });

                const qrDiv = document.createElement('div');
                qrDiv.className = 'qr-preview';
                qrDiv.id = `qr_${farmer.id}`;

                const qrContainer = document.createElement('div');
                qrDiv.appendChild(qrContainer);

                const qr = new QRCode(qrContainer, {
                    text: qrData,
                    width: qrSize,
                    height: qrSize,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                const label = document.createElement('div');
                label.className = 'farmer-label';
                label.textContent = farmer.name;
                qrDiv.appendChild(label);

                const info = document.createElement('div');
                info.className = 'farmer-info';
                info.innerHTML = `${farmer.location || '-'}<br>${farmer.phone || '-'}<br>${farmer.hp || '-'} HP`;
                qrDiv.appendChild(info);

                previewContainer.appendChild(qrDiv);

                // Store for PDF generation
                generatedQRs.push({
                    farmer: farmer,
                    qrElement: qrDiv
                });

                // Small delay to prevent browser freeze
                await new Promise(resolve => setTimeout(resolve, 50));
            }

            document.getElementById('qrCount').textContent = generatedQRs.length;
            document.getElementById('downloadBtn').disabled = false;

            // Scroll to preview
            previewContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        };

        window.downloadPDF = async () => {
            if (generatedQRs.length === 0) {
                alert('Please generate QR codes first!');
                return;
            }

            const btn = document.getElementById('downloadBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Generating PDF...';

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('portrait', 'mm', 'a4');

                const qrPerPage = parseInt(document.getElementById('qrPerPage').value);
                const qrSize = parseInt(document.getElementById('qrSize').value);

                // Calculate layout
                const cols = qrPerPage === 4 || qrPerPage === 6 ? 2 : 3;
                const rows = Math.ceil(qrPerPage / cols);

                const pageWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const margin = 15;
                const qrWidth = (pageWidth - (margin * 2) - ((cols - 1) * 10)) / cols;
                const qrHeight = (pageHeight - (margin * 2) - ((rows - 1) * 10)) / rows;

                let currentPage = 0;
                let position = 0;

                for (const item of generatedQRs) {
                    if (position % qrPerPage === 0 && position > 0) {
                        doc.addPage();
                        currentPage++;
                    }

                    const pagePos = position % qrPerPage;
                    const row = Math.floor(pagePos / cols);
                    const col = pagePos % cols;

                    const x = margin + (col * (qrWidth + 10));
                    const y = margin + (row * (qrHeight + 10));

                    // Get QR code canvas
                    const canvas = item.qrElement.querySelector('canvas');
                    const imgData = canvas.toDataURL('image/png');

                    // Add QR code to PDF
                    const qrImgSize = Math.min(qrWidth - 10, qrHeight - 25);
                    doc.addImage(imgData, 'PNG', x + 5, y + 5, qrImgSize, qrImgSize);

                    // Add farmer info
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text(item.farmer.name || 'Unknown', x + qrWidth / 2, y + qrImgSize + 12, { align: 'center', maxWidth: qrWidth - 5 });

                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.text(`${item.farmer.location || '-'}`, x + qrWidth / 2, y + qrImgSize + 17, { align: 'center', maxWidth: qrWidth - 5 });
                    doc.text(`${item.farmer.phone || '-'} ‚Ä¢ ${item.farmer.hp || '-'} HP`, x + qrWidth / 2, y + qrImgSize + 22, { align: 'center', maxWidth: qrWidth - 5 });

                    // Add border
                    doc.setDrawColor(200);
                    doc.setLineWidth(0.2);
                    doc.rect(x, y, qrWidth, qrHeight);

                    position++;
                }

                // Add footer to all pages
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text(`Solar Unloading System - Generated on ${new Date().toLocaleDateString()}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                    doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
                }

                // Save PDF
                const fileName = `Farmer_QR_Codes_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);

                btn.innerHTML = '‚úÖ PDF Downloaded!';
                setTimeout(() => {
                    btn.innerHTML = 'üìÑ Download PDF';
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('PDF generation error:', error);
                alert('Error generating PDF: ' + error.message);
                btn.innerHTML = 'üìÑ Download PDF';
                btn.disabled = false;
            }
        };

        // Initialize
        loadFarmers();
    </script>
</body>

</html>