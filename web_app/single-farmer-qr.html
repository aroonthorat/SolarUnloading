<!DOCTYPE html>
<html>

<head>
    <title>Single Farmer Material QR PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            max-height: 300px;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .preview-area {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            min-height: 200px;
        }

        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .qr-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .qr-item canvas {
            margin-bottom: 8px;
        }

        .qr-label {
            font-weight: bold;
            color: #333;
            font-size: 13px;
            margin-top: 8px;
        }

        .qr-serial {
            font-size: 10px;
            color: #666;
            margin-top: 5px;
            word-break: break-all;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .info-box strong {
            color: #667eea;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üì¶ Single Farmer Material QR PDF</h1>
        <p class="subtitle">
            Select one farmer and generate a PDF with all their equipment QR codes
        </p>

        <div class="form-group">
            <label for="farmerSearch">üîç Search Farmer:</label>
            <input type="text" id="farmerSearch" placeholder="Type farmer name to search..." oninput="filterFarmers()">

            <label for="farmerSelect" style="margin-top: 15px;">üë§ Select Farmer:</label>
            <select id="farmerSelect" size="8">
                <option value="">-- Loading farmers... --</option>
            </select>
        </div>

        <div id="equipmentInfo" style="display: none;" class="info-box">
            <strong>Equipment Found:</strong>
            <div id="equipmentList"></div>
        </div>

        <button class="btn btn-primary" onclick="generateAndDownloadPDF()" id="generateBtn" disabled>
            üìÑ Generate & Download PDF
        </button>

        <div class="preview-area" id="previewArea" style="display: none;">
            <h3 style="margin-bottom: 15px; color: #667eea;">Preview:</h3>
            <div id="qrContainer" class="equipment-grid"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAfRYoZT9c4O0flc39iROdgC1bTQkUXq88",
            authDomain: "gen-lang-client-0579320558.firebaseapp.com",
            projectId: "gen-lang-client-0579320558",
            storageBucket: "gen-lang-client-0579320558.firebasestorage.app",
            messagingSenderId: "770401014858",
            appId: "1:770401014858:web:placeholder"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let farmersData = [];
        let currentEquipment = [];

        // Check authentication
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadFarmers();
            } else {
                alert('Please log in first');
                window.location.href = 'index.html';
            }
        });

        async function loadFarmers() {
            try {
                const snapshot = await getDocs(collection(db, 'farmers_master'));

                farmersData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })).sort((a, b) => (a.name || '').localeCompare(b.name || ''));

                const select = document.getElementById('farmerSelect');
                select.innerHTML = '<option value="">-- Select a farmer --</option>';

                farmersData.forEach(farmer => {
                    const option = document.createElement('option');
                    option.value = farmer.id;
                    option.textContent = farmer.name || 'Unknown';
                    select.appendChild(option);
                });

                select.disabled = false;
                select.onchange = async () => {
                    if (select.value) {
                        await loadFarmerEquipment(select.value);
                    } else {
                        document.getElementById('equipmentInfo').style.display = 'none';
                        document.getElementById('previewArea').style.display = 'none';
                        document.getElementById('generateBtn').disabled = true;
                    }
                };

            } catch (error) {
                console.error('Error loading farmers:', error);
                alert('Error loading farmers: ' + error.message);
            }
        }

        // Filter farmers based on search input
        window.filterFarmers = function () {
            const searchText = document.getElementById('farmerSearch').value.toLowerCase();
            const select = document.getElementById('farmerSelect');

            // Clear current options except first
            select.innerHTML = '<option value="">-- Select a farmer --</option>';

            // Filter and add matching farmers
            const filtered = farmersData.filter(farmer =>
                (farmer.name || '').toLowerCase().includes(searchText)
            );

            filtered.forEach(farmer => {
                const option = document.createElement('option');
                option.value = farmer.id;
                option.textContent = farmer.name || 'Unknown';
                select.appendChild(option);
            });

            // Show count
            if (searchText && filtered.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '-- No farmers found --';
                option.disabled = true;
                select.appendChild(option);
            }
        };


        async function loadFarmerEquipment(farmerId) {
            try {
                // Find farmer details
                const farmer = farmersData.find(f => f.id === farmerId);
                const farmerName = farmer ? farmer.name : 'Unknown';
                const farmerBenId = farmer ? farmer.beneficiary_id : null;

                console.log('Looking for equipment for:', {
                    farmerId,
                    farmerName,
                    farmerBenId,
                    farmerData: farmer
                });

                // Load unloading records - try matching by both farmer_id AND farmer_name
                // Some records might use farmer_id, others might use farmer_name
                const snapshot = await getDocs(collection(db, 'unloading_records'));

                console.log('Total unloading records:', snapshot.size);

                currentEquipment = [];
                let matchedRecords = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();

                    // Try multiple matching strategies
                    const recordFarmerName = (data.farmer_name || data.farmerName || '').trim();
                    const searchFarmerName = (farmerName || '').trim();
                    const recordBenId = data.beneficiary_id || data.ben_id || data.benId;

                    const belongsToFarmer =
                        data.farmer_id === farmerId ||
                        recordFarmerName.toLowerCase() === searchFarmerName.toLowerCase() ||
                        (farmerBenId && recordBenId && recordBenId === farmerBenId);

                    if (belongsToFarmer) {
                        matchedRecords++;
                        console.log('‚úÖ Matched record:', {
                            docId: doc.id,
                            farmer_id: data.farmer_id,
                            farmer_name: data.farmer_name,
                            ben_id: recordBenId,
                            allFields: Object.keys(data)
                        });
                    }

                    if (!belongsToFarmer) return;

                    // Helper to safely get string
                    const getString = (val) => {
                        if (!val) return null;
                        if (typeof val === 'string') return val;
                        if (typeof val === 'object') return val.serial || val.qr || val.id || JSON.stringify(val);
                        return String(val);
                    };

                    // Check for controller - try multiple field names
                    const controllerQR = getString(data.controller_qr || data.controllerQr || data.controller || data.Controller);
                    if (controllerQR) {
                        currentEquipment.push({
                            type: 'Controller',
                            serial: controllerQR
                        });
                    }

                    // Check for pump - try multiple field names
                    const pumpQR = getString(data.pump_qr || data.pumpQr || data.pump || data.Pump);
                    if (pumpQR) {
                        currentEquipment.push({
                            type: 'Pump',
                            serial: pumpQR
                        });
                    }

                    // Check for motor - try multiple field names
                    const motorSerial = getString(data.motor_serial || data.motorSerial || data.motor || data.Motor);
                    if (motorSerial) {
                        currentEquipment.push({
                            type: 'Motor',
                            serial: motorSerial
                        });
                    }

                    // Check for panels - try multiple field names
                    const panelSerials = data.panel_serials || data.panelSerials || data.panels || data.Panels;
                    if (panelSerials && Array.isArray(panelSerials)) {
                        panelSerials.forEach((serial, index) => {
                            const serialStr = getString(serial);
                            if (serialStr) {
                                currentEquipment.push({
                                    type: `Panel #${index + 1}`,
                                    serial: serialStr
                                });
                            }
                        });
                    }
                });

                console.log('Matched records:', matchedRecords);
                console.log('Total equipment found:', currentEquipment.length);

                // Show equipment info
                const infoBox = document.getElementById('equipmentInfo');
                const equipmentList = document.getElementById('equipmentList');

                if (currentEquipment.length > 0) {
                    equipmentList.innerHTML = currentEquipment.map(e => `‚Ä¢ ${e.type}: ${e.serial}`).join('<br>');
                    infoBox.style.display = 'block';
                    document.getElementById('generateBtn').disabled = false;

                    // Generate preview
                    generatePreview();
                } else {
                    equipmentList.innerHTML = `‚ùå No equipment found for this farmer<br><small style="color: #999;">Searched ${matchedRecords} record(s). Check browser console (F12) for details.</small>`;
                    infoBox.style.display = 'block';
                    document.getElementById('generateBtn').disabled = true;
                    document.getElementById('previewArea').style.display = 'none';
                }

            } catch (error) {
                console.error('Error loading equipment:', error);
                alert('Error loading equipment: ' + error.message);
            }
        }

        function generatePreview() {
            const qrContainer = document.getElementById('qrContainer');
            qrContainer.innerHTML = '';

            console.log('üé® Generating preview for equipment:', currentEquipment);

            currentEquipment.forEach((item, index) => {
                console.log(`üì± Creating QR #${index + 1}:`, item.type, '=', item.serial);

                const qrItem = document.createElement('div');
                qrItem.className = 'qr-item';

                const qrDiv = document.createElement('div');
                qrDiv.style.display = 'inline-block';
                qrDiv.id = `qr-${index}`; // Add unique ID

                new QRCode(qrDiv, {
                    text: item.serial,
                    width: 120,
                    height: 120,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                qrItem.appendChild(qrDiv);

                const label = document.createElement('div');
                label.className = 'qr-label';
                label.textContent = item.type;
                qrItem.appendChild(label);

                const serial = document.createElement('div');
                serial.className = 'qr-serial';
                serial.textContent = item.serial;
                qrItem.appendChild(serial);

                qrContainer.appendChild(qrItem);
            });

            document.getElementById('previewArea').style.display = 'block';
            console.log('‚úÖ Preview generated with', currentEquipment.length, 'QR codes');
        }

        window.generateAndDownloadPDF = async () => {
            const btn = document.getElementById('generateBtn');
            const select = document.getElementById('farmerSelect');
            const farmerId = select.value;
            const farmer = farmersData.find(f => f.id === farmerId);
            const farmerName = farmer ? farmer.name : 'Unknown';

            btn.disabled = true;
            btn.textContent = '‚è≥ Generating PDF...';

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('portrait', 'mm', 'a4');

                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 15;

                // Farmer name header
                doc.setFontSize(20);
                doc.setTextColor(102, 126, 234);
                doc.setFont(undefined, 'bold');
                doc.text(farmerName, pageWidth / 2, margin + 12, { align: 'center' });

                doc.setFontSize(12);
                doc.setTextColor(100);
                doc.setFont(undefined, 'normal');
                doc.text(`${currentEquipment.length} Equipment Item(s)`, pageWidth / 2, margin + 20, { align: 'center' });

                // Draw line
                doc.setDrawColor(200);
                doc.line(margin, margin + 25, pageWidth - margin, margin + 25);

                // Pagination setup
                const qrSize = 55;
                const cols = 3;
                const xGap = 12; // Adjusted for better spacing
                const yGap = 25; // Space between rows including labels
                const startY = margin + 35;
                const itemWidth = qrSize;
                const itemHeight = qrSize + 20; // Height of QR + text labels
                // pageHeight is already defined above

                let currentCol = 0;
                let currentRow = 0;
                let yPosition = startY;

                const qrItems = document.querySelectorAll('.qr-item canvas');

                currentEquipment.forEach((item, index) => {
                    // Calculate position
                    let x = margin + (currentCol * (itemWidth + xGap));

                    // Check if we need a new page
                    if (yPosition + itemHeight > pageHeight - margin) {
                        doc.addPage();
                        yPosition = margin + 20; // New page start Y
                        currentCol = 0;
                        currentRow = 0;
                        x = margin; // Reset X
                    }

                    const canvas = qrItems[index];

                    if (canvas) {
                        const imgData = canvas.toDataURL('image/png');
                        doc.addImage(imgData, 'PNG', x, yPosition, qrSize, qrSize);

                        // Add labels
                        doc.setFontSize(9);
                        doc.setTextColor(0);
                        doc.setFont(undefined, 'bold');
                        doc.text(item.type, x + qrSize / 2, yPosition + qrSize + 5, { align: 'center', maxWidth: qrSize });

                        doc.setFontSize(7);
                        doc.setFont(undefined, 'normal');
                        const serialLines = doc.splitTextToSize(item.serial, qrSize);
                        doc.text(serialLines, x + qrSize / 2, yPosition + qrSize + 10, { align: 'center' });
                    }

                    // Advance column
                    currentCol++;
                    if (currentCol >= cols) {
                        currentCol = 0;
                        currentRow++;
                        yPosition += itemHeight + yGap;
                    }
                });

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`Solar Unloading System - ${new Date().toLocaleDateString()}`, margin, pageHeight - 10);

                // Save
                const fileName = `${farmerName.replace(/[^a-z0-9]/gi, '_')}_Material_QR_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);

                btn.textContent = '‚úÖ Downloaded!';
                setTimeout(() => {
                    btn.textContent = 'üìÑ Generate & Download PDF';
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('PDF Error:', error);
                alert('Error generating PDF: ' + error.message);
                btn.textContent = 'üìÑ Generate & Download PDF';
                btn.disabled = false;
            }
        };
    </script>
</body>

</html>